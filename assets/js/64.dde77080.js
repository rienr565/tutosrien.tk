(window.webpackJsonp=window.webpackJsonp||[]).push([[64],{450:function(t,s,a){"use strict";a.r(s);var e=a(5),n=Object(e.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"optimization-and-troubleshooting"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#optimization-and-troubleshooting"}},[t._v("#")]),t._v(" Optimization and Troubleshooting")]),t._v(" "),a("branch",{attrs:{version:"11.x"}},[a("p",[t._v("The Discord.js voice system allows your bot to join voice channels and play audio. This guide will teach you how to make simple music bots, and tips and tricks to optimize performance!")]),t._v(" "),a("p",[t._v("This voice guide is written for Discord.js v12, which features an improved audio system. Much of the example code in the voice guide is unsuitable for v11 and below - to access this content, please update Discord.js to v12!")])]),t._v(" "),a("branch",{attrs:{version:"12.x"}},[a("h2",{attrs:{id:"preparing-your-bot-for-debugging"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#preparing-your-bot-for-debugging"}},[t._v("#")]),t._v(" Preparing your bot for debugging")]),t._v(" "),a("p",[t._v("If you're experiencing issues, you can listen to debug information from the client and any voice connections you have. Below is a rudimentary example of a logger, although you can adapt it to suit your needs. Storing these logs will help when troubleshooting any issues you may have.")]),t._v(" "),a("p",[t._v("This will be very useful information if you need to report any issues with voice to our issue tracker.")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'debug'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("log"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nchannel"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("join")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("connection")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tconnection"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'debug'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("log"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h2",{attrs:{id:"stuttering-choppy-streams"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#stuttering-choppy-streams"}},[t._v("#")]),t._v(" Stuttering/choppy streams")]),t._v(" "),a("p",[t._v("This is likely due to a poor network connection, or your machine not having enough resources to play audio smoothly. This can be identified if the following occur:")]),t._v(" "),a("ol",[a("li",[t._v("Audio playback is only choppy on a specific network or machine.")]),t._v(" "),a("li",[t._v("There is a high rate of packet loss (you can identify this by joining a voice channel in Discord, clicking the signal indicator, selecting your bot and viewing the rate of packet loss).")])]),t._v(" "),a("p",[t._v("Besides allocating more resources to your bot and having a better network connection, there are also a few techniques we can use to try and improve performance to make playback smoother:")]),t._v(" "),a("h2",{attrs:{id:"solutions"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#solutions"}},[t._v("#")]),t._v(" Solutions")]),t._v(" "),a("h3",{attrs:{id:"using-ogg-webm-opus-streams"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#using-ogg-webm-opus-streams"}},[t._v("#")]),t._v(" Using Ogg/WebM Opus Streams")]),t._v(" "),a("h4",{attrs:{id:"from-local-files"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#from-local-files"}},[t._v("#")]),t._v(" From local files")]),t._v(" "),a("p",[t._v("Using Ogg/WebM Opus streams can greatly improve performance as it means an FFmpeg transcoder is not required at runtime. If you're playing audio from static files, you can just convert your files to Ogg Opus easily - this means the transcoder is run only once for the entire file when converting it, and not every single time the file is played.")]),t._v(" "),a("p",[t._v("You can run the following command to convert your audio files to Ogg Opus, provided you've "),a("RouterLink",{attrs:{to:"/voice/#installing-dependencies"}},[t._v("installed FFmpeg")]),t._v(":")],1),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ ffmpeg -i input.mp3 -c:a libopus -b:a 96k output.ogg\n")])])]),a("p",[t._v("You can specify a higher bitrate instead of "),a("code",[t._v("96k")]),t._v(" if your Discord server has a higher cap (e.g. VIP servers), but for most users 96k will be the highest they are able to play at.")]),t._v(" "),a("p",[t._v("You can also replace "),a("code",[t._v("input.mp3")]),t._v(" with any media file with an audio channel.")]),t._v(" "),a("p",[t._v("Once you've got your "),a("code",[t._v("output.ogg")]),t._v(" audio file, you can play it like so:")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" fs "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'fs'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nconnection"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("play")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("createReadStream")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'output.ogg'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" type"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'ogg/opus'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("And that's it! Discord.js will not create an FFmpeg transcoder for your file, and will instead demux the Opus audio from it, greatly improving performance.")]),t._v(" "),a("h4",{attrs:{id:"from-youtube-videos"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#from-youtube-videos"}},[t._v("#")]),t._v(" From YouTube videos")]),t._v(" "),a("p",[t._v("Many voice bots allow an ability to play audio from YouTube videos in voice channels. YouTube itself provides WebM/Ogg streams for newer videos, and so we can also demux these files for Opus audio instead of running them through an FFmpeg transcoder first.")]),t._v(" "),a("p",[t._v("To do this, you can use the "),a("a",{attrs:{href:"https://github.com/amishshah/ytdl-core-discord",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("ytdl-core-discord")]),a("OutboundLink")],1),t._v(" module. It will play WebM/Ogg Opus streams directly where possible, and will fallback to FFmpeg for incompatible videos - this should help you achieve the best performance when using YouTube streams.")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" ytdl "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'ytdl-core-discord'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("play")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("connection"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" url")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tconnection"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("play")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ytdl")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" type"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'opus'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),a("p",[t._v("You might be wondering why the type is "),a("code",[t._v("opus")]),t._v(" and not "),a("code",[t._v("webm/opus")]),t._v(" or "),a("code",[t._v("ogg/opus")]),t._v(". Discord.js allows us to play Opus streams "),a("strong",[t._v("without a container")]),t._v(" operating in object-mode (i.e. each item pushed to the stream is a distinct Opus packet). "),a("code",[t._v("ytdl-core-discord")]),t._v(" provides this type of stream, and so we must specify "),a("code",[t._v("opus")]),t._v(" as the type.")])]),t._v(" "),a("h3",{attrs:{id:"using-highwatermark"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#using-highwatermark"}},[t._v("#")]),t._v(" Using "),a("code",[t._v("highWaterMark")])]),t._v(" "),a("p",[t._v("Another way to improve performance is through altering the "),a("code",[t._v("highWaterMark")]),t._v(" property. This property, put simply, describes how many packets of Opus audio should be available to the stream at any given time.")]),t._v(" "),a("p",[t._v("The default value for this property is "),a("code",[t._v("12")]),t._v(" - this equates to 240 ms of audio ready to play at any given time. You can adjust the property like so:")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Have 50 audio packets ready (1 second of playback)")]),t._v("\nconnection"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("play")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'file.mp3'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" highWaterMark"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("50")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("You can try increasing this property to improve choppy playback, but increasing it too much will mean that playback will take longer to start, and any changes to volume will not take effect immediately.")]),t._v(" "),a("h3",{attrs:{id:"disabling-inline-volume"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#disabling-inline-volume"}},[t._v("#")]),t._v(" Disabling Inline Volume")]),t._v(" "),a("p",[t._v("If you're not going to change the volume of your stream in real-time, you can disable the volume transformer Discord.js creates for you. You'll need to do this before playing the stream:")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Disable volume transformer")]),t._v("\nconnection"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("play")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("audioStream"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" volume"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("Once you've done this, you will "),a("strong",[t._v("not")]),t._v(" be able to change the volume of your StreamDispatcher.")]),t._v(" "),a("p",[t._v("This will not have a big impact on performance, but can still help you improve the efficiency of your bot nevertheless.")])])],1)}),[],!1,null,null,null);s.default=n.exports}}]);